<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>iWall</title>

        <style>
            html, body {
                background: #002b36;
            }

            .page-element {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
            }
            
            .page-element h2 {
                margin: 0;
                padding: 0;
                fontsize: 1.1em;
            }

            .centered-box {
                position: fixed;
                top: 50%;
                left: 50%;

                width: 650px;
                height: 300px;

                margin-top: -150px;
                margin-left: -325px;
            }

            .inside-element {
                text-align: center;
                font-family: sans-serif;
                font-size: 5em;
                color: white;
            }
            .element-loading {

            }

            .facebook-block {
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 200;

                background: white;
                padding: 20px;
                width: 10%;
                height: 60px;
            }
        </style>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

        <script type="text/javascript">

        </script>
    </head>
    <body>
        <div id="fb-root"></div>
        <script>
            var pages = new Array();

            var initialPage = new Object();
            initialPage.elementCls = "element-initial";
            initialPage.html = "Welcome to lifeField!";
            pages.push(initialPage);

            var visibleElement = ".element-loading";
            var facebookLastChecked = 0;

            function changeElement(clsName) {
                $(".element-success").hide();
                var oldElem = $(visibleElement);
                var newElem = $("." + clsName);
                console.log("Fading out " + oldElem + "; fading in " + newElem);
                $("body").css("background-color", oldElem.css("background-color"));
                oldElem.fadeOut(function() {
                    newElem.fadeIn();
                    visibleElement = "." + clsName;
                });
                
                //elem.removeClass("visible-element");
                //elem.addClass("hidden-element");
                //$("." + clsName).removeClass("hidden-element")
                //$("." + clsName).addClass("visible-element");
            }

            window.fbAsyncInit = function() {
                // init the FB JS SDK
                FB.init({
                    appId: '717167621630717', // App ID from the app dashboard
                    channelUrl: '//jblew.pl/lifefield/channel.php', // Channel file for x-domain comms
                    status: true, // Check Facebook Login status
                    xfbml: true, // Look for social plugins on the page
                    cookie: true
                });

                // Here we subscribe to the auth.authResponseChange JavaScript event. This event is fired
                // for any authentication related change, such as login, logout or session refresh. This means that
                // whenever someone who was previously logged out tries to log in again, the correct case below 
                // will be handled. 
                FB.Event.subscribe('auth.authResponseChange', function(response) {
                    console.log("EVT");
                    // Here we specify what we do with the response anytime this event occurs. 
                    if (response.status === 'connected') {
                        changeElement("element-success");
                    } else if (response.status === 'not_authorized') {
                        // In this case, the person is logged into Facebook, but not into the app, so we call
                        // FB.login() to prompt them to do so. 
                        // In real-life usage, you wouldn't want to immediately prompt someone to login 
                        // like this, for two reasons:
                        // (1) JavaScript created popup windows are blocked by most browsers unless they 
                        // result from direct interaction from people using the app (such as a mouse click)
                        // (2) it is a bad experience to be continually prompted to login upon page load.
                        FB.login();
                    } else {
                        // In this case, the person is not logged into Facebook, so we call the login() 
                        // function to prompt them to do so. Note that at this stage there is no indication
                        // of whether they are logged into the app. If they aren't then they'll see the Login
                        // dialog right after they log in to Facebook. 
                        // The same caveats as above apply to the FB.login() call here.
                        FB.login();
                    }
                });

                FB.getLoginStatus(function(response) {
                    if (response.status === 'connected') {
                        //logged into facebook, authorized app
                        var uid = response.authResponse.userID;
                        var accessToken = response.authResponse.accessToken;

                        loop(uid, accessToken);
                    } else {
                        changeElement("element-login");
                    }
                });
            };

            // Load the SDK asynchronously
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "//connect.facebook.net/pl_PL/all.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));

            function testAPI() {
                console.log('Welcome!  Fetching your information.... ');
                FB.api('/me', function(response) {
                    console.log('Good to see you, ' + response.name + '.');
                }
                );
            }
            $(document).ready(function() {
                $("#btn-update-permission").click(function() {
                    console.log('Goind go update permission...');
                    FB.api('/me/permissions', function(response) {
                        var perms = response.data[0];
                        console.log(perms);
                        if (perms.read_stream) {
                            changeElement('element-permission-not-changed')
                        } else {
                            console.log("Asking for more permission");
                            /*FB.login(function(response) {
                             console.log(response);
                             if (response.status === 'connected') {
                             changeElement('element-permission-updated');
                             }
                             else {
                             changeElement('element-permission-not-changed')
                             }
                             }, {scope: 'read_stream'});*/
                            Facebook.showPermissionDialog('read_stream', function(resp) {
                                console.log(resp);
                            }, function(resp) {
                                console.log(resp);
                            }, '');
                        }
                    });
                });
            });

            function checkFacebook() {
                /*FB.api({
                 method: 'fql.query',
                 query: 'SELECT post_id, actor_id, target_id, message FROM stream WHERE filter_key in (SELECT filter_key FROM stream_filter WHERE uid=me() AND type=\'newsfeed\') AND is_hidden = 0'
                 }, function(posts) {*/
                FB.api('/me/home', function(response) {
                    console.log(response);
                    var posts = response.data;
                    for (var i = 0; i < posts.length; i++) {
                        var post = posts[i];
                        var page = new Object();
                        page.html = "<h2>" + post.from.name + "</h2><p>" + post.message + "</p>";
                        page.elementCls = "element-facebook-post";
                        page.priority = 1;
                        pages.push(page);
                        facebookLastChecked = (new Date()).getTime();
                        console.log("Facebook checked");
                    }
                    console.log(posts);
                });
            }

            function loop() {
                var time = 5000;
                if ((new Date()).getTime() - facebookLastChecked > 1000 * 60 * 5)
                    checkFacebook();

                var page = pages[Math.round(Math.random() * pages.length)];
                //var page = pages[0];
                $("." + page.elementCls + " .inside-element").html(page.html);
                changeElement(page.elementCls);

                setTimeout("loop();", time);
            }
        </script>
        <div class="facebook-block">
            <fb:login-button show-faces="true" width="200" max-rows="1" scope="read_stream"></fb:login-button>
            <!--<a id="btn-update-permission" href="javascript:;">Update permission</a>-->
        </div>
        <div class="page-element element-loading" style="background-color: #002b36;">
            <div class="centered-box inside-element">
                Loading...
            </div>
        </div>
        <div class="page-element element-login"  style="display: none; background-color: #3b5998;">
            <div class="centered-box inside-element">
                Log in to enjoy!
            </div>
        </div>
        <div class="page-element element-success" style="display: none; background-color: #859900;">
            <div class="centered-box inside-element">
                Success!
            </div>
        </div>
        <div class="page-element element-permission-updated" style="display: none; background-color: #3b5998;">
            <div class="centered-box inside-element">
                Permission updated!
            </div>
        </div>
        <div class="page-element element-permission-not-changed" style="display: none; background-color: #3b5998;">
            <div class="centered-box inside-element">
                Permission not changed.
            </div>
        </div>
        <div class="page-element element-facebook-post" style="display: none; background-color: #3b5998;">
            <div class="centered-box inside-element">
                Content
            </div>
        </div>
        <div class="page-element element-initial" style="display: none; background-color: #859900;">
            <div class="centered-box inside-element">
                Welcome
            </div>
        </div>
    </body>
</html>
